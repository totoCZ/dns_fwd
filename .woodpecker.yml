when:
  event: push

steps:
  build:
    image: golang
    environment:
      GOOS: linux
      GOARCH: amd64
      GOCACHE: /ci-cache/go-build
      GOMODCACHE: /ci-cache/go-modules
    volumes:
      - ci-cache:/ci-cache
    commands:
      - go mod download
      - go build -ldflags="-s -w"

  container:
    image: quay.io/buildah/stable:latest
    privileged: true
    volumes:
      - ci-cache:/var/lib/containers/storage
      - /etc/containers/registries.conf.d/:/etc/containers/registries.conf.d/
    environment:
      USERNAME: ${CI_REPO_OWNER}
      PASSWORD:
        from_secret: forgejo_token
    commands:
      - buildah login -u "$USERNAME" -p "$PASSWORD" forgejo.pod.hetmer.net
      - buildah bud -t forgejo.pod.hetmer.net/${CI_REPO_OWNER}/${CI_REPO_NAME}:latest .
      - buildah push forgejo.pod.hetmer.net/${CI_REPO_OWNER}/${CI_REPO_NAME}:latest

